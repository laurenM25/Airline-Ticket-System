<!DOCTYPE html>
<html>

<head>
    <title>Analytics</title>
    <link rel="stylesheet" href="static/general.css">

    <!--fix issue-->
    <script>
        const ticket_labels = {{ ticket_labels | tojson | safe }};
        const ticket_values = {{ ticket_values | tojson | safe }};
        const commission_labels = {{ commission_labels | tojson | safe }};
        const commission_values = {{ commission_values | tojson | safe }};
    </script>
</head>

<body>
    <div class="topBar">
        <div class="left-top"></div>
        <div class="center-top">
            <span class="webpage-title">Air Ticket Reservation </span>
        </div>
        <div class="right-top">
            <span class="username">Welcome {{username}}</span>
            <a class='logout-link' href="/logout">log out</a>
        </div>
    </div>
    <div class="sideNav">
        <h3>Tools</h3>
        {% if usertype %}
        {% if usertype == "customer" %}
        <a class='page-link' href="/browseFlights">Browse Flights</a>
        <a class='page-link' href="/purchasedFlights">View purchased flights</a>
        <a class='page-link' href="/spendingStats">View spending stats</a>
        {% endif %}

        {% if usertype == "agent" %}
        <a class='page-link' href="/purchasedFlightsA">View flights purchased for clients</a>
        <a class='page-link' href="/browseFlightsA">Browse flights</a>
        <a class='page-link' href="/analyticsA">Analytics</a>
        {% endif %}

        {% if usertype == "airline_staff" %}
        <a class='page-link' href="/upcomingFlightsStaff">View upcoming flights for your airline</a>
        <a class='page-link' href="/passengerList">Check passenger list by flight number</a>
        <a class='page-link' href="/customersFlights">Look up flights taken by a customer</a>
        <a class='page-link' href="/analyticsStaff">Analytics</a>
        {% endif %}

        {% endif %}

        {% if specialperm %}
        {% if "admin" in specialperm %}
        <h3>Admin Tools</h3>
        <a class='page-link' href="/addAirport">Add new airport</a>
        <a class='page-link' href="/addAirplane">Add new airplane</a>
        <a class='page-link' href="/createFlight">Create flight</a>
        <a class='page-link' href="/assignAgent">Assign agent to airline</a>
        {% endif %}

        {% if "operator" in specialperm %}
        <h3>Operator Tools</h3>
        <a class='page-link' href="/updateStatus">Update flight status</a>
        {% endif %}
        {% endif %}
    </div>
    <div class="main-content">
        <div>
            <p>Total commission in past 30 days: {{commissions_total}}</p>
            <p>Average commission per ticket in past 30 days: ${{avg_commission | round(2)}}</p>
            <!--used jinja filter for decimal formatting-->
            <p>Number of tickets sold all time: {{num_tickets_sold}}</p>
        </div>
        <div>
            <!-- using Chart.js to make bar chart -->
            <canvas id="top5-ticket" style="width:100%;max-width:700px"></canvas>

            <canvas id="top5-commission" style="width:100%;max-width:700px"></canvas>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script>
        const ctx = document.getElementById('top5-ticket');

        const barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ticket_labels,
                datasets: [{
                    backgroundColor: "steelblue",
                    data: ticket_values
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Top 5 Customers by Number of Tickets Sold in Past 6 months"
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,           // start from 0
                            stepSize: 1,                 // force integer steps
                            callback: function (value) {  // make sure it displays as integer
                                return Number.isInteger(value) ? value : null;
                            }
                        }
                    }]
                }

            }
        });
    </script>
    <script>
        const ctx2 = document.getElementById('top5-commission');

        const barChart2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: commission_labels,
                datasets: [{
                    backgroundColor: "steelblue",
                    data: commission_values
                }]
            },
            options: {
                title: {
                    display: true,
                    text: "Top 5 Customers by Cumulative Commisions in Past 12 months"
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,  // start from 0
                        callback: function (value) {
                            return '$' + value;  // prepend $ to tick labels
                        }
                    }
                }]
            }
        });
    </script>
</body>

</html>